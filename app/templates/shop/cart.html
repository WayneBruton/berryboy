{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4">Shopping Cart</h1>
    
    <div class="cart-items mb-4">
        <div id="cart-items-container">
            <!-- Cart items will be dynamically loaded here -->
        </div>
        <div id="empty-cart-message" class="text-center py-5" style="display: none;">
            <p class="lead">Your cart is empty</p>
            <a href="{{ url_for('shop.products') }}" class="btn btn-primary">Continue Shopping</a>
        </div>
    </div>
    
    <div class="cart-summary mt-4">
        <div class="d-flex justify-content-between">
            <h4>Total:</h4>
            <h4 id="cart-total">R0.00</h4>
            <input type="hidden" id="cart-total-value" value="0.00">
        </div>
        
        <!-- PayFast Payment Form -->
        <div class="mt-3" id="payment-form-container">
            <form name="PayFastPayNowForm" action="https://payment.payfast.io/eng/process" method="post">
                <input required type="hidden" name="cmd" value="_paynow">
                <input required type="hidden" name="receiver" pattern="[0-9]" value="13459781">
                <input type="hidden" name="return_url" value="https://berryboy.onrender.com">
                <input type="hidden" name="cancel_url" value="https://berryboy.onrender.com/cart">
                <input type="hidden" name="notify_url" value="https://berryboy.onrender.com/cart">
                <input required type="hidden" name="amount" id="payfast-amount" value="0.00">
                <input required type="hidden" name="item_name" maxlength="255" value="The Berry Boy">
                <input type="hidden" name="item_description" maxlength="255" value="Premium berries and berry products from The Berry Boy">
                <div class="text-center">
                    <label for="payfast-amount" style="padding-bottom: 10px;">Payfast: </label>
                    <input type="image" src="https://my.payfast.io/images/buttons/BuyNow/Primary-Large-BuyNow.png" alt="Buy Now" title="Buy Now with PayFast" class="mt-1">
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Function to directly update the cart count correctly
function updateCartCountDirectly() {
    // Get cart items from localStorage
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    
    // Calculate the correct total (explicitly parsing as integers)
    const totalItems = cartItems.reduce(function(sum, item) {
        return sum + parseInt(item.quantity || 0);
    }, 0);
    
    // Update the cart icon
    const cartCount = document.querySelector('.cart-count');
    if (cartCount) {
        cartCount.textContent = totalItems;
    }
}

// Update cart count immediately when the page loads
updateCartCountDirectly();

// Cart display functionality
document.addEventListener('DOMContentLoaded', function() {
    // Get cart items from localStorage
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    const cartContainer = document.getElementById('cart-items-container');
    const emptyCartMessage = document.getElementById('empty-cart-message');
    const cartTotal = document.getElementById('cart-total');
    
    // Function to update cart icon across all pages
    function updateCartIconGlobally(count) {
        // Update all cart count elements on the page
        document.querySelectorAll('.cart-count').forEach(el => {
            el.textContent = count;
        });
        
        // Also update localStorage value to stay in sync
        const currentCart = JSON.parse(localStorage.getItem('cart')) || [];
        const totalQuantity = currentCart.reduce((sum, item) => sum + item.quantity, 0);
        if (totalQuantity !== count) {
            // If server count is different, force refresh all tabs
            localStorage.setItem('cartCount', count);
            // Dispatch a storage event to notify other tabs
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'cartCount',
                newValue: count.toString()
            }));
        }
    }
    
    // Function to update the cart display
    async function updateCartDisplay() {
        // Clear current cart display
        cartContainer.innerHTML = '';
        
        // If cart is empty, show empty cart message
        if (cartItems.length === 0) {
            emptyCartMessage.style.display = 'block';
            cartContainer.style.display = 'none';
            cartTotal.textContent = 'R0.00';
            return;
        }
        
        // Cart has items, hide empty message
        emptyCartMessage.style.display = 'none';
        cartContainer.style.display = 'block';
        
        // Keep track of total price
        let totalPrice = 0;
        
        // Create a table for cart items
        const table = document.createElement('table');
        table.className = 'table';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="cart-table-body"></tbody>
        `;
        
        cartContainer.appendChild(table);
        const tableBody = document.getElementById('cart-table-body');
        
        // Load product details for each cart item
        const productPromises = cartItems.map(item => {
            return fetch(`/api/products/${item.id}`)
                .then(response => response.json())
                .catch(error => {
                    console.error('Error fetching product:', error);
                    return null;
                });
        });
        
        // Create a fallback in case we can't get product details
        const fallbackProducts = cartItems.map(item => ({
            id: item.id,
            name: `Product #${item.id}`,
            price: 0,
            quantity: item.quantity
        }));
        
        // Try to get product details, use fallbacks if needed
        let products;
        try {
            products = await Promise.all(productPromises);
            // Filter out any null responses
            products = products.filter(p => p !== null);
            
            // If we didn't get any products, use the fallbacks
            if (products.length === 0) {
                products = fallbackProducts;
            }
        } catch (error) {
            console.error('Error loading products:', error);
            products = fallbackProducts;
        }
        
        // Create a row for each cart item
        products.forEach((product, index) => {
            const item = cartItems.find(i => i.id == product.id) || { quantity: 1 };
            const itemTotal = product.price * item.quantity;
            totalPrice += itemTotal;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.name}</td>
                <td>R${product.price.toFixed(2)}</td>
                <td>
                    <div class="input-group input-group-sm" style="width: 120px;">
                        <button class="btn btn-outline-secondary decrease-quantity" data-id="${product.id}">-</button>
                        <input type="number" class="form-control text-center item-quantity" value="${item.quantity}" min="1" data-id="${product.id}">
                        <button class="btn btn-outline-secondary increase-quantity" data-id="${product.id}">+</button>
                    </div>
                </td>
                <td>R${itemTotal.toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-danger remove-item" data-id="${product.id}">
                        <i class="bi bi-trash"></i> Remove
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Update the total price display
        cartTotal.textContent = `R${totalPrice.toFixed(2)}`;
        
        // Update the hidden total value field and PayFast amount field
        document.getElementById('cart-total-value').value = totalPrice.toFixed(2);
        document.getElementById('payfast-amount').value = totalPrice.toFixed(2);
        
        // Show/hide the payment form based on cart contents
        const paymentFormContainer = document.getElementById('payment-form-container');
        if (totalPrice <= 0) {
            paymentFormContainer.style.display = 'none';
        } else {
            paymentFormContainer.style.display = 'block';
        }
        
        // Add event listeners for quantity and remove buttons
        document.querySelectorAll('.decrease-quantity').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                const item = cartItems.find(i => i.id == id);
                if (item && item.quantity > 1) {
                    // Use the global cart utility to update quantity
                    window.cartOperations.updateQuantity(id, item.quantity - 1)
                        .catch(error => console.error('Error updating quantity:', error));
                    
                    // Update local cart
                    item.quantity--;
                    localStorage.setItem('cart', JSON.stringify(cartItems));
                    
                    // Update cart count directly
                    updateCartCountDirectly();
                    
                    updateCartDisplay();
                }
            });
        });
        
        document.querySelectorAll('.increase-quantity').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                const item = cartItems.find(i => i.id == id);
                if (item) {
                    // Use the global cart utility to update quantity
                    window.cartOperations.updateQuantity(id, item.quantity + 1)
                        .catch(error => console.error('Error updating quantity:', error));
                    
                    // Update local cart
                    item.quantity++;
                    localStorage.setItem('cart', JSON.stringify(cartItems));
                    
                    // Update cart count directly
                    updateCartCountDirectly();
                    
                    updateCartDisplay();
                }
            });
        });
        
        document.querySelectorAll('.item-quantity').forEach(input => {
            input.addEventListener('change', function() {
                const id = this.dataset.id;
                const newQuantity = parseInt(this.value);
                if (newQuantity < 1) this.value = 1;
                
                const item = cartItems.find(i => i.id == id);
                if (item) {
                    const finalQuantity = Math.max(1, newQuantity);
                    
                    // Use the global cart utility to update quantity
                    window.cartOperations.updateQuantity(id, finalQuantity)
                        .catch(error => console.error('Error updating quantity:', error));
                    
                    // Update local cart
                    item.quantity = finalQuantity;
                    localStorage.setItem('cart', JSON.stringify(cartItems));
                    
                    // Update cart count directly
                    updateCartCountDirectly();
                    
                    updateCartDisplay();
                }
            });
        });
        
        document.querySelectorAll('.remove-item').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                const itemIndex = cartItems.findIndex(i => i.id == id);
                if (itemIndex !== -1) {
                    // Use the global cart utility to remove item
                    window.cartOperations.removeItem(id)
                        .catch(error => console.error('Error removing item:', error));
                    
                    // Then update client-side cart
                    cartItems.splice(itemIndex, 1);
                    localStorage.setItem('cart', JSON.stringify(cartItems));
                    
                    // Update the cart count directly
                    updateCartCountDirectly();
                    
                    // Update the display
                    updateCartDisplay();
                }
            });
        });
    }
    
    // Initialize the cart display
    updateCartDisplay();
    
    // Make sure cart count is always accurate
    window.updateCartCount();
});
</script>
{% endblock %}
